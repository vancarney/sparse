<!DOCTYPE html>

<html>
<head>
  <title>sParse</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1>sParse</h1>
<p>(c)2013 Van Carney</p>
<h3>A <em>sparse</em> Parse API for Backbone</h3>
<blockquote>
<p>Design Goals:
&bullet; Be small and compact
&bullet; Go wherever Backbone can go with no added dependencies or restrictions
&bullet; &#39;Drop In&#39; to any existing Backbone Application (where Backbone source code is unadulterated)
&bullet; Provide complete Parse API coverage (in a future release TBD)</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>global = exports ? window</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>include  Backbone and Underscore if we are in a Node App</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">if</span> <span class="keyword">typeof</span> exports != <span class="string">'undefined'</span>
  _         = require(<span class="string">'underscore'</span>)._
  Backbone  = require(<span class="string">'backbone'</span>);
(-&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>restrict our code to use less dangerous functionality</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="string">'use strict'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>define the &#39;sparse&#39; global namespace</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> !global.sparse
    sparse = global.sparse =</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Our current version</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      VERSION:<span class="string">"0.2.1-alpha"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>APP_ID stores the Parse API Application Identifier</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      APP_ID:<span class="literal">undefined</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>REST_KEY stores the Parse API REST Access Key</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      REST_KEY:<span class="literal">undefined</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>SESSION_TOKEN, stored the user session token if logged in</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      SESSION_TOKEN:<span class="literal">undefined</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>the supported version of the Parse API</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      API_VERSION:<span class="string">"1"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Batch request object length (set to -1 to disable sub-batching)
note: changing this may cause Batch requests to fail</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      MAX_BATCH_SIZE:<span class="number">50</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Parse limits fetch requests to 100 records and provides no pagination
To circumvent this, we iverride the Fetch Limit to attempt to pull all records
Set this to a lower or higher amount to suit your needs
See also: REST API Queries</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      DEFAULT_FETCH_LIMIT_OVERRIDE: <span class="number">200000</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>The default ClassName to use for Models and Collections</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      UNDEFINED_CLASSNAME:<span class="string">'__UNDEFINED_CLASSNAME__'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Base URI for the Parse API</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      API_URI:<span class="string">"https://api.parse.com/1"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Mappings from CRUD to REST</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      CRUD_METHODS:
        create: <span class="string">'POST'</span>
        read:   <span class="string">'GET'</span>
        update: <span class="string">'PUT'</span>
        destroy:<span class="string">'DELETE'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <h3>sparse.apiOPTS</h3>
<p>Utility function to generate a Parse API Header</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      apiOPTS: -&gt;
        contentType: <span class="string">"application/json"</span>
        processData: <span class="literal">false</span>
        dataType: <span class="string">'json'</span>
        data: <span class="literal">null</span>
        headers:
          <span class="string">'Content-Type'</span>            : <span class="string">'application/json'</span>
          <span class="string">'X-Parse-Application-Id'</span>  : sparse.APP_ID
          <span class="string">'X-Parse-REST-API-Key'</span>    : sparse.REST_KEY
          <span class="string">'X-Parse-Session-Token'</span>   : sparse.SESSION_TOKEN
      getConstructorName: (fun)-&gt;
        fun.constructor.name || <span class="keyword">if</span> (n=fun.constructor.toString().match <span class="regexp">/function+\s{1,}([A-Z]{1}[a-zA-Z]*)/</span>)? <span class="keyword">then</span> n[<span class="number">1</span>] <span class="keyword">else</span> sparse.UNDEFINED_CLASSNAME</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <h3>sparse.Inflection</h3>
<p>Basic Inflection utility used to convert Class Names</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      Inflection: <span class="keyword">new</span> (-&gt;
        __uncountable_words:[<span class="string">'equipment'</span>, <span class="string">'information'</span>, <span class="string">'rice'</span>, <span class="string">'money'</span>, <span class="string">'species'</span>, <span class="string">'series'</span>,<span class="string">'fish'</span>, <span class="string">'sheep'</span>, <span class="string">'moose'</span>, <span class="string">'deer'</span>, <span class="string">'news'</span>]
        __plural_rules:[
          [<span class="regexp">/(m)an$/gi</span>,                  <span class="string">'$1en'</span>],
          [<span class="regexp">/(pe)rson$/gi</span>,               <span class="string">'$1ople'</span>],
          [<span class="regexp">/(child)$/gi</span>,                <span class="string">'$1ren'</span>],
          [<span class="regexp">/^(ox)$/gi</span>,                  <span class="string">'$1en'</span>],
          [<span class="regexp">/(ax|test)is$/gi</span>,            <span class="string">'$1es'</span>],
          [<span class="regexp">/(octop|vir)us$/gi</span>,          <span class="string">'$1i'</span>],
          [<span class="regexp">/(alias|status)$/gi</span>,         <span class="string">'$1es'</span>],
          [<span class="regexp">/(bu)s$/gi</span>,                  <span class="string">'$1ses'</span>],
          [<span class="regexp">/(buffal|tomat|potat)o$/gi</span>,  <span class="string">'$1oes'</span>],
          [<span class="regexp">/([ti])um$/gi</span>,               <span class="string">'$1a'</span>],
          [<span class="regexp">/sis$/gi</span>,                    <span class="string">'ses'</span>],
          [<span class="regexp">/(?:([^f])fe|([lr])f)$/gi</span>,   <span class="string">'$1$2ves'</span>],
          [<span class="regexp">/(hive)$/gi</span>,                 <span class="string">'$1s'</span>],
          [<span class="regexp">/([^aeiouy]|qu)y$/gi</span>,        <span class="string">'$1ies'</span>],
          [<span class="regexp">/(x|ch|ss|sh|lens)$/gi</span>,      <span class="string">'$1es'</span>],
          [<span class="regexp">/(matr|vert|ind)ix|ex$/gi</span>,   <span class="string">'$1ices'</span>],
          [<span class="regexp">/([m|l])ouse$/gi</span>,            <span class="string">'$1ice'</span>],
          [<span class="regexp">/(quiz)$/gi</span>,                 <span class="string">'$1zes'</span>],
          [<span class="regexp">/s$/gi</span>,                      <span class="string">'s'</span>],
          [<span class="regexp">/$/gi</span>,                       <span class="string">'s'</span>]
        ]</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>find and apply the appropriate Regex for the given string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        apply_rules: (str, rules, skip)-&gt;
          <span class="keyword">if</span> (skip.indexOf str.toLowerCase()) == -<span class="number">1</span>
            <span class="keyword">return</span> str.replace rx[<span class="number">0</span>], rx[<span class="number">1</span>] <span class="keyword">if</span> (rx = _.find rules, (itm)=&gt;str.match itm[<span class="number">0</span>])?
          str</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>pluralizes a string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        pluralize: (str)-&gt;
          <span class="property">@apply_rules</span> str, <span class="property">@__plural_rules</span>, <span class="property">@__uncountable_words</span>
      )</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>OP
class sparse.OP
class sparse.OP.ADD
objects</p>
<h3>sparse.Model</h3>
<p>represents a single Parse Object Row Association</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="class"><span class="keyword">class</span> <span class="title">sparse</span>.<span class="title">Model</span> <span class="keyword">extends</span> <span class="title">Backbone</span>.<span class="title">Model</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>map our Backbone.Model id attribute to Parse Api&#39;s objectId attribute</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    idAttribute: <span class="string">"objectId"</span>
    constructor:(attributes, options)-&gt;
      <span class="keyword">super</span> attributes, options
      <span class="property">@className</span> = sparse.getConstructorName @ <span class="keyword">if</span> <span class="keyword">typeof</span> <span class="property">@className</span> == <span class="string">'undefined'</span> <span class="keyword">or</span> <span class="property">@className</span> == <span class="literal">null</span>
      console.warn <span class="string">"sparse.Collection requires className to be defined"</span> <span class="keyword">if</span> <span class="property">@className</span> == sparse.UNDEFINED_CLASSNAME 
      <span class="property">@className</span> = sparse.Inflection.pluralize <span class="property">@className</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>generates a Parse API URL for this object based on the Class name</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    url : -&gt;
      <span class="string">"<span class="subst">#{sparse.API_URI}</span>/classes/<span class="subst">#{@className}</span><span class="subst">#{ <span class="keyword">if</span> !@.isNew() <span class="keyword">then</span> '/'+(@.get 'objectId') <span class="keyword">else</span> '' }</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>override native Backbone.Collection.sync to apply custom API header and data (if any)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    sync : (method, model, options={})-&gt;
      opts = sparse.apiOPTS()
      opts.data = JSON.stringify @.toJSON()
      Backbone.Model.prototype.sync.call @, method, model, _.extend( options, opts )</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>override toJSON handler</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    toJSON : (options)-&gt;
      data = Model.__super__.toJSON.call @, options
      <span class="keyword">delete</span> data.createdAt
      <span class="keyword">delete</span> data.updatedAt
      data</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <h1>Sparse.Object API compat</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>    __ops:[]
    increment: (attr, amount)-&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <h1>sparse.Model.saveAll</h1>
<p>Parse API compatability, replaces Parse.Object.saveAll
Sets up and executes a sparse.Batch process</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  sparse.Model.<span class="function"><span class="title">saveAll</span></span> = (list, options)-&gt;
    (<span class="keyword">new</span> sparse.Batch list
    ).exec 
      complete:(m,r,o)=&gt;
        options.success m,r,o <span class="keyword">if</span> options.success
      error:(m,r,o)=&gt;
        options.error m,r,o <span class="keyword">if</span> options.error</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <h3>sparse.Collection</h3>
<p>represents a complete Parse Object and all row associations</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="class"><span class="keyword">class</span> <span class="title">sparse</span>.<span class="title">Collection</span> <span class="keyword">extends</span> <span class="title">Backbone</span>.<span class="title">Collection</span></span>
    __count:<span class="literal">undefined</span>
    count:-&gt;
      <span class="property">@__count</span> || <span class="property">@models</span>.length
    constructor : (attributes, options)-&gt;
      <span class="keyword">super</span> attributes, options</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>inspects our Class for the extending Class&#39;s class name if not already set directly by user</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="property">@className</span> = sparse.getConstructorName @ <span class="keyword">if</span> <span class="keyword">typeof</span> <span class="property">@className</span> == <span class="string">'undefined'</span> <span class="keyword">or</span> <span class="property">@className</span> == <span class="literal">null</span>
      console.warn <span class="string">"sparse.Collection requires className to be defined"</span> <span class="keyword">if</span> <span class="property">@className</span> == sparse.UNDEFINED_CLASSNAME
      <span class="property">@className</span> = sparse.Inflection.pluralize <span class="property">@className</span>
    __params:
      limit: sparse.DEFAULT_FETCH_LIMIT_OVERRIDE
      count:<span class="number">1</span>
    getParams:-&gt;
      ( _.map _.pairs( <span class="property">@__params</span> || <span class="literal">null</span> ), (v,k)=&gt;v.join <span class="string">'='</span> ).join <span class="string">'&amp;'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>generates a Parse API URL for this object based on the Class name</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    url : -&gt;
      encodeURI <span class="string">"<span class="subst">#{sparse.API_URI}</span>/classes/<span class="subst">#{@className}</span><span class="subst">#{<span class="keyword">if</span> @__method == 'read' <span class="keyword">and</span> (p=@getParams()).length <span class="keyword">then</span> '?'+p <span class="keyword">else</span> ''}</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>override local Collection.parse method to handle Parse API nesting of results into a results object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    parse : (options)-&gt;
      data = Collection.__super__.parse.call @, options
      data.results || data</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>override native Backbone.Collection.sync to apply custom API header and data (if any)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    sync : (<span class="property">@__method</span>, model, options={})-&gt;
      opts      = sparse.apiOPTS()</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>basic query support for order, count, limit and query    </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> <span class="property">@__method</span> == <span class="string">'read'</span>
        _.each [<span class="string">'order'</span>,<span class="string">'count'</span>,<span class="string">'limit'</span>,<span class="string">'where'</span>], (v,k)=&gt;
          <span class="keyword">if</span> options[v]
            <span class="property">@__params</span>[v] = JSON.stringify options[v]
            <span class="keyword">delete</span> options[v]
      opts.<span class="function"><span class="title">success</span></span> = (m,r,o)=&gt;
        <span class="property">@__params</span> =
          limit: sparse.DEFAULT_FETCH_LIMIT_OVERRIDE
          count:<span class="number">1</span>
        options.success m, r, o <span class="keyword">if</span> options.success?
      Backbone.Collection.prototype.sync.call @, <span class="property">@__method</span>, model, _.extend( _.clone(options), opts )</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>convenience function to allow user to fetching with a query</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    query : (query, options={})-&gt;
      <span class="property">@fetch</span> _.extend(options, where:query)</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>convenience function for saving any new and changed objects in the collection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    save : (options)-&gt;
      _.each <span class="property">@models</span>, (v,k)=&gt;
        v.fetch options <span class="keyword">if</span> v.isNew() <span class="keyword">or</span> v.hasChanged()</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <h3>sparse.User</h3>
<p>Model for Parse&#39;s special User Object Type</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  class sparse.User extends sparse.Model
    defaults:
      username:null
      password:null
      email:null
    __action:'operate'
    urlMap:
      create:"#{sparse.API_URI}/users"
      login:"#{sparse.API_URI}/login"
      passwordReset:"#{sparse.API_URI}/requestPasswordReset"
      operate:"#{sparse.API_URI}/users"
    url:-&gt;
      @urlMap[@__action] + ( if @__action == 'operate' and !@isNew() then "/#{@get 'objectId'}" else '')
    logout:-&gt;
      sparse.SESSION_TOKEN = undefined
      @urlMap['login'] = @urlMap['login'].replace /\/login+.*/, '/login'
    login:(username, password, options)-&gt;
      @__action = 'login'
      @urlMap['login'] = encodeURI @urlMap['login'].replace /\/login+.*/, "/login?username=#{username}&amp;password=#{password}"
      opts = {}
      opts.success = (m,r,o)=&gt;
        sparse.SESSION_TOKEN = @get 'sessionToken'
        delete @attributes.sessionToken
        options.success m,r,o if options.success
      @fetch _.extend _.clone(options), opts
    save:(attributes, options)-&gt;
      @__action = (if @.isNew() then 'create' else 'operate')
      User.__super__.save.call @, attributes, options
    destroy:(options)-&gt;
      @__action = 'operate'
      opts = {}
      opts.success = (m,r,o)=&gt;
        @logout()
        options.success m,r,o if options.success
      User.__super__.destroy.call @, _.extend( _.clone(options), opts )
    resetPassword:(options)-&gt;
      if (email = @get 'email') == null
        return false
      @__action = 'passwordReset'
      User.__super__.save.call @, {email:email}, options</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <h3>sparse.UserCollection</h3>
<p>Collection to retrieve and manage Parse User Objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="class"><span class="keyword">class</span> <span class="title">sparse</span>.<span class="title">Users</span> <span class="keyword">extends</span> <span class="title">sparse</span>.<span class="title">Collection</span></span>
    url:-&gt;
      <span class="string">"<span class="subst">#{sparse.API_URI}</span>/users"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <h3>sparse.Batch</h3>
<p>Utility Class to Create, Update and Destroy many various Parse Objects in a single request</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="class"><span class="keyword">class</span> <span class="title">sparse</span>.<span class="title">Batch</span> <span class="keyword">extends</span> <span class="title">sparse</span>.<span class="title">Collection</span></span>
    constructor : (attributes, options)-&gt;
      <span class="keyword">super</span> attributes, options</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Batch uses a hardcoded url to the API_URL/batch resource</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    url : -&gt;
      <span class="string">"<span class="subst">#{sparse.API_URI}</span>/batch"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>hold processed models by batch</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    __processed:[]</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>retrieve flattened processed models</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    processed:(flatten=<span class="literal">true</span>)-&gt;
      <span class="keyword">if</span> flatten  <span class="keyword">then</span> _.flatten <span class="property">@__processed</span> <span class="keyword">else</span> <span class="property">@__processed</span></pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>override the local toJSON method to wrap the model into a &#39;requests&#39; object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    toJSON : (options)-&gt;
      JSON.stringify requests : Batch.__super__.toJSON.call @, options</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>a safer way to check for new models in our Batch </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _memberIsNew: (attrs)-&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>test to see if there is an isNew property, if not, see if we have an objectId and evaluate it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      (attrs.hasOwnProperty(<span class="string">'isNew'</span>) &amp;&amp; attrs.isNew()) || (<span class="keyword">typeof</span>(attrs.get <span class="string">'objectId'</span>)  == <span class="string">'undefined'</span> || attrs.get <span class="string">'objectId'</span> == <span class="literal">null</span> || attrs.get <span class="string">'objectId'</span> == <span class="string">""</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>override the local _prepareModel method</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _prepareModel : (attrs, options={})-&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>we will assume this is a create or update if thedestroy param has not been set in the options</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      options = _.extend(options, {destroy:<span class="literal">false</span>}) <span class="keyword">if</span> !(options.hasOwnProperty <span class="string">'destroy'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>we should not attempt to destroy an object that has never been created</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> options.destroy <span class="keyword">and</span> <span class="property">@_memberIsNew</span> attrs
        obj = <span class="literal">null</span> 
      <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>replace the given Model with a Sparse.Batch formatted model </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        obj =
          method  :  sparse.CRUD_METHODS[<span class="keyword">if</span> options.destroy <span class="keyword">then</span> <span class="string">'destroy'</span> <span class="keyword">else</span> (<span class="keyword">if</span> <span class="property">@_memberIsNew</span> attrs <span class="keyword">then</span> <span class="string">'create'</span> <span class="keyword">else</span> <span class="string">'update'</span>)]
          path    : <span class="string">"/<span class="subst">#{sparse.API_VERSION}</span>/classes/<span class="subst">#{attrs.className}</span><span class="subst">#{<span class="keyword">if</span> !@_memberIsNew attrs <span class="keyword">then</span> '/'+ attrs.get 'objectId' <span class="keyword">else</span> ''}</span>"</span>
        obj.body = attrs <span class="keyword">if</span> !options.destroy
      Backbone.Collection.prototype._prepareModel.call @, obj, options</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>override the local call to Backbone.sync</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    sync : (method, model, options)-&gt;
      <span class="keyword">return</span> <span class="keyword">if</span> !model.models <span class="keyword">or</span> model.models.length == <span class="number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>prepare to overwrite standard options with API specific headers and params</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      opts      = sparse.apiOPTS()</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>grab a subset of our data to fit within Parse&#39;s Batch Operation Limit</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      opts.data = JSON.stringify requests : (<span class="property">@__to_remove</span> = model.slice <span class="number">0</span>, (<span class="keyword">if</span> sparse.MAX_BATCH_SIZE &gt;= <span class="number">0</span> <span class="keyword">and</span> sparse.MAX_BATCH_SIZE &lt; model.models.length <span class="keyword">then</span> sparse.MAX_BATCH_SIZE <span class="keyword">else</span> model.models.length) )</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>create custom success handlerfor sequential batch operations on large datasets</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      opts.<span class="function"><span class="title">success</span></span>  = (m,r,o)=&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>apply the changes to the original model and concat the processed models to the __processed array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="property">@__processed</span>.push _.map m, (v,k,l) =&gt; _.chain(<span class="property">@__to_remove</span>[k].get <span class="string">'body'</span>).tap((_o) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>deleted items will be undefined, so just pass back the success results </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="keyword">if</span> <span class="keyword">typeof</span> _o != <span class="string">'undefined'</span> <span class="keyword">then</span> _o.set v.success <span class="keyword">else</span> _o = v.success
        ).value()</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>remove data objects pending removal from the last operation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="property">@remove</span> <span class="property">@__to_remove</span>, {index: <span class="number">0</span>, silent:<span class="literal">true</span>}
        setTimeout (=&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>if we still have data in our model, we will send it to sync</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="keyword">if</span> model.models.length  &gt; <span class="number">0</span>
            <span class="property">@sync</span> method, @, options
          <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>if no data is left, send a complete event</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            options.complete <span class="property">@__processed</span>, r, o <span class="keyword">if</span> options.complete
        ), <span class="number">200</span></pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>invoke user supplied success callback if provided</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        options.success m,r,o <span class="keyword">if</span> options.success
      opts.<span class="function"><span class="title">error</span></span>    = (m,r,o)=&gt; options.error m,r,o <span class="keyword">if</span> options.error
      opts.<span class="function"><span class="title">complete</span></span> = (m,r,o)=&gt; options.completed m,r,o <span class="keyword">if</span> options.completed 
      Backbone.sync method, model, _.extend( _.clone(options), opts  )</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>fetch is not supported since Batch is not for READ operations</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    fetch : (options) -&gt; console.warn <span class="string">'fetch is not supported by sparse.Batch try using sparse.Collection instead'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>execute the Batch Operation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    exec : (options) -&gt; <span class="property">@sync</span> <span class="string">'create'</span>, @, options</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>add a record or records to be deleted from the Server </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    destroy : (models, options) -&gt; <span class="property">@add</span> models, _.extend _.clone(options || {}), destroy:<span class="literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>add a record or records to be added to the Server</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    save : (models, options) -&gt; <span class="property">@add</span> models, options
).call @</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
